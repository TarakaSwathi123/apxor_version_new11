!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("apxor")):"function"==typeof define&&define.amd?define(["apxor"],t):(e=e||self)["apxor-qe"]=t(e.Apxor)}(this,(function(e){"use strict";function t(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function i(e){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?t(Object(n),!0).forEach((function(t){_(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,u(n.key),n)}}function a(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _(e,t,i){return(t=u(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||d(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){if(e){if("string"==typeof e)return c(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function l(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=d(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,_=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){_=!0,r=e},f:function(){try{a||null==i.return||i.return()}finally{if(_)throw r}}}}function u(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var v=function(e){return void 0!==e&&!function(e){return null===e}(e)},p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function g(e,t){return Array.from(t).map((function(t,i){return String.fromCharCode(t^function(e,t){return e.charCodeAt(Math.floor(t%e.length))}(e,i))})).join("")}var f=function(e,t){return g(e,t=function(e){var t,i,n,o,r,a,_=0,s=[];if(!e)return e;e+="";do{t=(a=p.indexOf(e.charAt(_++))<<18|p.indexOf(e.charAt(_++))<<12|(o=p.indexOf(e.charAt(_++)))<<6|(r=p.indexOf(e.charAt(_++))))>>16&255,i=a>>8&255,n=255&a,s.push(t),64!==o&&(s.push(i),64!==r&&s.push(n))}while(_<e.length);return s}(t))},m=function(e){switch(e){case"app_event":return"AE";case"client_event":return"CE";case"activity_time":case"activity_event":return"AE";case"apxor_event":return"AEV";case"customer_event":return"CEV";case"any_event":return"ANV";case"campaign_event":return"CNV";case"survey_event":return"SVE"}return"Unknown"},h=function(e){return e.toUpperCase()},y=function(e,t,i){switch(i){case"EQ":return e===t;case"GT":return e>t;case"GTE":return e>=t;case"LT":return e<t;case"LTE":return e<=t;case"NEQ":return e!==t;case"R":return C(t).test(e);default:return!1}},E=function(e,t){switch(e){case"second":return 1e3*t;case"minute":return 60*t*1e3;case"hour":return 60*t*60*1e3;case"day":return 24*t*60*60*1e3;default:return 1}},C=function(e){var t=e.replace(/.*\/([gimuy]*)$/,"$1");t===e&&(t="");var i=t?e.replace(new RegExp("^/(.*?)/"+t+"$"),"$1"):e;return new RegExp(i,t)},x=function(){var e=new Date;return e.getDate()+"/"+e.getMonth()+"/"+e.getFullYear()},S=window.ApxorLogger,b=a((function t(){var i=this;o(this,t),_(this,"_type","ALL"),_(this,"_userAttributes",[]),_(this,"_sessionAttributes",[]),_(this,"userAttributesValidated",!0),_(this,"sessionAttributeValidated",!0),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(i._type=e.audience.audience_type,i._userAttributes=e.audience.attributes.user,i._sessionAttributes=e.audience.attributes.session,!Array.isArray(i._userAttributes)||!Array.isArray(i._sessionAttributes))return S.error("No attributes"),!1}catch(e){return S.error(e),!1}return!0})),_(this,"validate",(function(t,n){var o=!0;"FTU"===i._type&&(o=e.getController().getSessionInfo().is_first_session);var r=i._compareAttributes(t,i._userAttributes),a=i._compareAttributes(n,i._sessionAttributes);return r||(i.userAttributesValidated=!1),a||(i.sessionAttributeValidated=!1),o&&r&&a})),_(this,"_compareAttributes",(function(e,t){var i=t.length,n=!0;try{for(var o,r=function(){var i=t[a];if(void 0===e[i.name]||!1===n)return{v:!1};var o=i.operator,r=i.type,_=i.value.map((function(e){if("s"===r)return e;if("l"===r)return parseInt(e);if("f"===r)return parseFloat(e);if("b"===r)switch(e){case"true":return!0;case"false":return!1}})),s=(Array.isArray(e[i.name])?e[i.name]:[e[i.name]]).some((function(e){return _.some((function(t){return"s"===r?e="".concat(e):"l"===r?e=parseInt(e):"f"===r?e=parseFloat(e):"b"===r&&(e=!!e),y(e,t,o)}))}));n=n&&s},a=0;a<i;a++)if(o=r())return o.v}catch(e){S.error(e),n=!1}return n}))})),F=window.ApxorLogger,T=a((function e(){var t=this;o(this,e),_(this,"_count",0),_(this,"_timeInterval",0),_(this,"_validity","SESSION"),_(this,"_shownCount",0),_(this,"_sessionCount",0),_(this,"_originalCount",0),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{t._count=e.frequency.count,-1===t._count&&(t._count=1e3),t._originalCount=t._count,t._timeInterval=e.frequency.time_interval,t._validity=e.frequency.validity,t._sessionCount=e.frequency.ses_lmt,t._dayCount=e.frequency.day_lmt;var i=H.getInstance().getQeState();if(!v(i)||!v(i[e._id]))return!0;if("SESSION"===t._validity){if(t._count=parseInt(t._count)-parseInt(i[e._id].SESSION),t._count<=0)return console.warn("Max count limit reached for session:"+e._id),!1}else{if("OVERALL"!==t._validity)return F.info("Invalid config."),!1;if(t._count=parseInt(t._count)-parseInt(i[e._id].OVERALL),t._count<=0)return console.warn("Max count limit reached for overall:"+e._id),!1}}catch(e){return F.error(e),!1}return!0})),_(this,"decrementCampaignCount",(function(){t._count=t._count-1})),_(this,"getFrequencyCount",(function(){return t._count})),_(this,"resetCampaignCount",(function(){"SESSION"===t._validity&&(t._count=t._originalCount,F.info("Campaign Limit reset"))})),_(this,"isFrequencyWithInLimits",(function(e){try{if(t._count<=0)return!1;var i=H.getInstance().getQeState();if(!v(i)||!v(i[e]))return!0;if(0!==t._sessionCount)if(parseInt(t._sessionCount)-parseInt(i[e].SESSION)<=0)return!1;if(0!==t._dayCount){var n,o=x();if(parseInt(t._dayCount)-parseInt((null===(n=i[e])||void 0===n?void 0:n.DATES[o])||0)<=0)return!1}}catch(e){F.error("Error validating the frequency:"+e)}return!0}))})),w=a((function e(){var t=this;o(this,e),_(this,"_name",""),_(this,"_type",""),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var i,n;t._name=e.meta.name,t._type=e.meta.type,t._only_context=e.meta.only_context,t._attr=(null===(i=e.meta)||void 0===i?void 0:i.attr)||{},t._isExperiment=null===(n=e.meta)||void 0===n?void 0:n.isExperiment}catch(e){return window.ApxorLogger.error(e),!1}return!0}))})),A=window.ApxorLogger,I=a((function e(){var t=this;o(this,e),_(this,"_startDate",-1),_(this,"_endDate",-1),_(this,"_startTime",-1),_(this,"_endTime",-1),_(this,"_timeLimits",!1),_(this,"_nudge_expired",!1),_(this,"_not_yet_active",!1),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(isNaN(Date.parse(e.validity.start_date))||isNaN(Date.parse(e.validity.end_date)))return A.error("Not valid dates"),!1;if(t._startDate=Date.parse(e.validity.start_date),t._endDate=Date.parse(e.validity.end_date),v(e.time_limits_in_day)&&(t._timeLimits=e.time_limits_in_day,t._timeLimits&&v(e.time_limits))){var i=(new Date).toISOString().split("T")[0];if(t._startTime=Date.parse(i+"T"+e.time_limits.start_time+".000Z"),t._endTime=Date.parse(i+"T"+e.time_limits.end_time+".000Z"),isNaN(t._startTime)||isNaN(t._endTime))return A.error("Not valid times"),!1}}catch(e){return A.error(e),!1}return!0})),_(this,"validate",(function(){var e=Date.now();return e>t._startDate&&e<t._endDate?!t._timeLimits||e>=t._startTime&&e<=t._endTime:(e<t._startDate?t._not_yet_active=!0:e>t._endDate&&(t._nudge_expired=!0),!1)}))})),V=a((function e(){var t=this;o(this,e),_(this,"_name",""),_(this,"_additionalInfo",{}),_(this,"_path",""),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{t._name=e.name,t._additionalInfo=e.additional_info,t._path=null==e?void 0:e.path}catch(e){return!1}return!0}))})),N=a((function e(){var t=this;o(this,e),_(this,"_lower",0),_(this,"_upper",0),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(t._lower=Number(e.lower),t._upper=Number(e.upper),isNaN(t._lower)||isNaN(t._upper))return!1}catch(e){return!1}return!0}))})),O=a((function e(){var t=this;o(this,e),_(this,"_occurredTime",0),_(this,"_eventType",""),_(this,"_navigation",""),_(this,"_details",new V),_(this,"_timeBounds",new N),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{return t._eventType=e.event_type,t._navigation=e.activity,t._details.parse(e.details)&&t._timeBounds.parse(e.time_bounds)}catch(e){return!1}}))})),R=window.ApxorLogger,q=a((function e(){var t=this;o(this,e),_(this,"_occurredTime",0),_(this,"_sequence",-1),_(this,"_count",0),_(this,"_countOperator",""),_(this,"_navigation",""),_(this,"_eventType",""),_(this,"_timeBounds",new N),_(this,"_details",new V),_(this,"_precondition",new O),_(this,"_combineOperator","AND"),_(this,"_canCheckOldData",!1),_(this,"_type",void 0),_(this,"_route",""),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var i,n;return t._sequence=null==e?void 0:e.sequence,t._conditionType=null==e?void 0:e.condition_type,t._id=null==e?void 0:e.id,t._eventCategory=null!=e&&e.event_category?null==e?void 0:e.event_category:"specific_event",t._count=null==e||null===(i=e.count_config)||void 0===i?void 0:i.count,t._countOperator=null==e||null===(n=e.count_config)||void 0===n?void 0:n.operator,t._navigation=null==e?void 0:e.activity,t._eventType=null==e?void 0:e.event_type,t._combineOperator=e.combine_operator,t._timeEnabled=null==e?void 0:e.time_enabled,t._time=null==e?void 0:e.time,t._type=null==e?void 0:e.type,t._route=null==e?void 0:e.route,t._details.parse(null==e?void 0:e.details)&&t._precondition.parse(e.trigger)&&t._timeBounds.parse(e.time_bounds)}catch(e){return R.error(e),!1}}))})),D=window.ApxorLogger,K=a((function e(){var t=this;o(this,e),_(this,"_count",0),_(this,"_countOperator",""),_(this,"_eventType",""),_(this,"_timeBounds",new N),_(this,"_details",new V),_(this,"_combineOperator","AND"),_(this,"parse",(function(e){try{return t._count=e.count_config.count,t._countOperator=e.count_config.operator,t._eventType=e.event_type,t._combineOperator=e.combine_operator,t._details.parse(e.details)&&t._timeBounds.parse(e.time_bounds)}catch(e){return D.error(e),!1}}))})),L=window.ApxorLogger,k=function(){function t(){var i=this;o(this,t),_(this,"_satisfiedCount",0),_(this,"_uuid",""),_(this,"_condition",new q),_(this,"_goalevent",new K),_(this,"_triggered",!1),_(this,"_isSatisfied",!1),_(this,"_index",0),_(this,"_combineOperator","AND"),_(this,"_conbineOperatorForGoalEvent","OR"),_(this,"_oldEventCount",-1),_(this,"_kpi",[]),_(this,"_eventTimes",{}),_(this,"_receivedEventForKpi",!1),_(this,"_respectSequence",void 0),_(this,"_childConditionIndex",void 0),_(this,"no_KPI_TriggerDetails",[]),_(this,"initialize",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],_=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1,c=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if(i._uuid=n,i._index=o,i._kpi=a,i._respectSequence=r,i.childConditionIndex=d,i.across_sessions=_||!1,"termination"===s&&""!==s){i._goalevent.parse(t);return i._conbineOperatorForGoalEvent=i._goalevent._combineOperator,i.registerForTermination(),!0}var l=i._condition.parse(t);if(l){if(i._combineOperator=i._condition._combineOperator,i._condition._canCheckOldData){var u=i._condition._details._name;"APX_PAGE_OPENED"===u&&(u=i._condition._details._additionalInfo.navigation_id,u=v(u)?u:i._condition._details._name),i._oldEventCount=e.getController().getEventCount(u);var p=i._condition._count,g=i._condition._countOperator;if(i._isSatisfied=i._compare(i._oldEventCount-1,p,g,!1),i._triggered=i._isSatisfied,i._isSatisfied&&"APX_PAGE_OPENED"===i._condition._details._name)return!0}return!0===c&&(r&&0!==o&&"unordered"!==r||i.register()),!0}return!1})),_(this,"register",(function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;-1!=t&&(i._childConditionIndex=t);var n=i._condition,o=null!=n&&n._eventCategory?null==n?void 0:n._eventCategory:"specific_event",r=n._precondition,a=H.getInstance();if("app_start"===r._eventType)if(i._triggered=!0,null!=n&&n._timeEnabled){if("session"!=(null==n?void 0:n._time.unit)){var _=E(n._time.unit,n._time.value);"didn't"==(null==n?void 0:n._type)?(console.log("in didnt"),setTimeout((function(){i._receivedEventForKpi||(i._isSatisfied=!0,i._isSatisfied&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&(i._condition._occurredTime=Date.now(),a.validate(i._uuid,i._index,i._childConditionIndex)))),"specific_event"===o?a.unregisterFromEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForNoKpi):i.unregisterForGivenEventCategoryNOKPI(o),i._triggered=!1}),_),"specific_event"===o?a.registerForEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForNoKpi):i.registerForGivenEventCategoryNOkpi(o)):"did"==(null==n?void 0:n._type)&&(console.log("did condition"),setTimeout((function(){"specific_event"===o?a.unregisterFromEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForKpiNew):i.unregisterFromGivenEventCategoryKPI(o)}),_),"specific_event"===o?a.registerForEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForKpiNew):i.registerForGivenEventCategoryKPI(o))}}else console.log("on receive event1"),"specific_event"===o?a.registerForEvent(m(n._eventType)+"___"+n._details._name,i._onReceiveEvent):i.registerForGivenEventCategory(o);else if(null!=n&&n._timeEnabled){if("session"!=(null==n?void 0:n._time.unit)){var s=E(n._time.unit,n._time.value);"didn't"==(null==n?void 0:n._type)?(setTimeout((function(){i._receivedEventForKpi||(i._isSatisfied=!0,i._isSatisfied&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&(i._condition._occurredTime=Date.now(),a.validate(i._uuid,i._index)))),"specific_event"===o&&a.unregisterFromEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i),i._triggered=!1}),s),"specific_event"===o?a.registerForEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForNoKpi):i.registerForGivenEventCategoryNOkpi()):"did"==(null==n?void 0:n._type)&&(console.log("did condition"),setTimeout((function(){"specific_event"===o&&a.unregisterFromEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForKpiNew)}),s),"specific_event"===o&&a.registerForEvent(m(i._condition._eventType)+"___"+i._condition._details._name,i._onReceiveEventForKpiNew))}}else"specific_event"===o&&a.registerForEvent(m(n._eventType)+"___"+r._details._name,i._onReceiveEvent);null!==(e=window.ApxorRTM)&&void 0!==e&&e.badgesLists.includes(i._uuid)&&(console.log("on receive event3"),a.registerForEvent(m(n._eventType)+"___"+"apxor-badge-container-".concat("-".concat(i._uuid).replaceAll(" ","").replace(/[^\w\s]/gi,"")),i._onReceiveEvent))})),_(this,"registerForGivenEventCategory",(function(e){var t=new H;"apxor_event"===e?t.registerForEvent("apxor_event",(function(e,t,n,o){i._onReceiveEvent(m(i._condition._eventType),i._condition._details._name,n,i._condition._details._additionalInfo)})):"customer_event"===e?t.registerForEvent("customer_event",(function(e,t,n,o){i._onReceiveEvent(m(i._condition._eventType),i._condition._details._name,n,i._condition._details._additionalInfo)})):"any_event"===e?t.registerForEvent("any_event",(function(e,t,n,o){i._onReceiveEvent(m(i._condition._eventType),i._condition._details._name,n,i._condition._details._additionalInfo)})):"campaign_event"===e?t.registerForEvent("campaign_event",(function(e,t,n,o){i._onReceiveEvent(m(i._condition._eventType),i._condition._details._name,n,i._condition._details._additionalInfo)})):"survey_event"===e&&t.registerForEvent("survey_event",(function(e,t,n,o){i._onReceiveEvent(m(i._condition._eventType),i._condition._details._name,n,i._condition._details._additionalInfo)}))})),_(this,"unregisterForGivenEventCategoryNOKPI",(function(e){console.log("in new register");var t=new H,n=i._condition._eventCategory;"apxor_event"===n?t.unregisterFromEvent("apxor_event",i._onReceiveEventForNoKpi):"customer_event"===n?t.unregisterFromEvent("customer_event",i._onReceiveEventForNoKpi):"any_event"===n?t.unregisterFromEvent("any_event",i._onReceiveEventForNoKpi):"campaign_event"===n?t.unregisterFromEvent("campaign_event",i._onReceiveEventForNoKpi):"survey_event"===n&&t.unregisterFromEvent("survey_event",i._onReceiveEventForNoKpi)})),_(this,"registerForGivenEventCategoryNOkpi",(function(){console.log("in new register");var e=new H,t=i._condition._eventCategory;"apxor_event"===t?e.registerForEvent("apxor_event",i._onReceiveEventForNoKpi):"customer_event"===t?e.registerForEvent("customer_event",i._onReceiveEventForNoKpi):"any_event"===t?e.registerForEvent("any_event",i._onReceiveEventForNoKpi):"campaign_event"===t?e.registerForEvent("campaign_event",i._onReceiveEventForNoKpi):"survey_event"===t&&e.registerForEvent("survey_event",i._onReceiveEventForNoKpi)})),_(this,"registerForGivenEventCategoryKPI",(function(){var e=new H,t=i._condition._eventCategory;"apxor_event"===t?e.registerForEvent("apxor_event",i._onReceiveEventForKpiNew):"customer_event"===t?e.registerForEvent("customer_event",i._onReceiveEventForKpiNew):"any_event"===t?e.registerForEvent("any_event",i._onReceiveEventForKpiNew):"campaign_event"===t?e.registerForEvent("campaign_event",i._onReceiveEventForKpiNew):"survey_event"===t&&e.registerForEvent("survey_event",i._onReceiveEventForKpiNew)})),_(this,"unregisterFromGivenEventCategoryKPI",(function(){var e=new H,t=i._condition._eventCategory;"apxor_event"===t?e.unregisterFromEvent("apxor_event",i._onReceiveEventForKpiNew):"customer_event"===t?e.unregisterFromEvent("customer_event",i._onReceiveEventForKpiNew):"any_event"===t?e.unregisterFromEvent("any_event",i._onReceiveEventForKpiNew):"campaign_event"===t?e.unregisterFromEvent("campaign_event",i._onReceiveEventForKpiNew):"survey_event"===t&&e.unregisterFromEvent("survey_event",i._onReceiveEventForKpiNew)})),_(this,"registerForTermination",(function(){var e=i._goalevent,t=H.getInstance();i._triggered=!0,t.registerForEvent(m(e._eventType)+"___"+e._details._name,i._onReceiveEventForTermination)})),_(this,"_onReceiveEventForKpiForSameEvent",(function(e,t,n,o){var r,a=(Date.now()-i._eventTimes[t])/1e3;(null===(r=i._condition)||void 0===r||null===(r=r._details)||void 0===r||null===(r=r._additionalInfo)||void 0===r?void 0:r.time)/1e3>a&&i._displayCampaign(n)})),_(this,"_onReceiveEventForKpi",(function(e,t,n,o){var r,a;i._receivedEventForKpi=!0;var _=Date.now(),s=null===(r=i._condition)||void 0===r||null===(r=r._precondition)||void 0===r?void 0:r._details._name,d=(_-i._eventTimes[s])/1e3,c=null===(a=i._condition)||void 0===a||null===(a=a._details)||void 0===a||null===(a=a._additionalInfo)||void 0===a?void 0:a.time;(c/=1e3)>d&&i._displayCampaign(n)})),_(this,"_onReceiveEventForKpiNew",(function(){console.log("configitem kpi check2");var e=new H;i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&e.validate(i._uuid,i._index)})),_(this,"_onReceiveEventForNoKpi",(function(e,t,n,o){i._receivedEventForKpi=!0})),_(this,"_onReceiveEvent",(function(t,n,o,r){var a,_;console.log("in onreceive event"),console.log("across session value is ",i.across_sessions);var s=H.getInstance();if(i._triggered){if(null!==(a=window.ApxorRTM)&&void 0!==a&&a.isBadgePresent&&null!==(_=window.ApxorRTM)&&void 0!==_&&_.badgesLists.includes(i._uuid)&&e.getController().isBadgeTriggerSatisfied(i._uuid))return i._isSatisfied=!0,i._condition._occurredTime=o,void s.validate(i._uuid,i._index);if(m(i._condition._eventType)===t&&i._validateTimeBounds(o-i._condition._precondition._occurredTime,i._condition._timeBounds)&&i._condition._details._name===n&&i._compareAdditionalInfo(i._condition._details._additionalInfo,r)&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied)){if(i._condition._occurredTime=o,i.across_sessions){var d=E(i._condition._time.unit,i._condition._time.value),c=i._condition._timeEnabled,l=i._condition._id,u=i._satisfiedCount;i._persistSatisfiedConditions(i._condition._type,n,o,r,d,c,l,u)}s.validate(i._uuid,i._index,i._childConditionIndex)}}else if(i._triggered=i._validatePrecondition(t,n,o,r),i._triggered){var v=i._condition,p=v._precondition;if(p._occurredTime=o,"activity_time"===(null==v?void 0:v._eventType)){var g,f,y,C,x=null==v||null===(g=v._details)||void 0===g||null===(g=g._additionalInfo)||void 0===g?void 0:g.time;(null==v||null===(f=v._route)||void 0===f?void 0:f.length)>0?setTimeout((function(){var t;(null===(t=e.getController())||void 0===t?void 0:t._appEventsNoKpi).length<=2&&v._route===location.pathname&&i._displayCampaign(o)}),x):(null==v||null===(y=v._details)||void 0===y||null===(y=y._additionalInfo)||void 0===y?void 0:y.nkpi.length)>0?(setTimeout((function(){i._receivedEventForKpi||(i._isSatisfied=!0,i._isSatisfied&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&(i._condition._occurredTime=o,s.validate(i._uuid,i._index)))),v._details._additionalInfo.nkpi.map((function(e){s.unregisterFromEvent(h(v._details._additionalInfo.et)+"___"+e,i),i._triggered=!1}))}),x),v._details._additionalInfo.nkpi.map((function(e){s.registerForEvent(h(v._details._additionalInfo.et)+"___"+e,i._onReceiveEventForNoKpi)}))):(null==v||null===(C=v._details)||void 0===C||null===(C=C._additionalInfo)||void 0===C?void 0:C.kpi.length)>0&&(setTimeout((function(){v._details._additionalInfo.kpi.map((function(e){s.unregisterFromEvent(h(v._details._additionalInfo.et)+"___"+e,i)}))}),x),v._details._additionalInfo.kpi.map((function(e){e===v._precondition._details._name?(s.unregisterFromEvent(m(p._eventType)+"___"+p._details._name,i),s.registerForEvent(h(v._details._additionalInfo.et)+"___"+e,i._onReceiveEventForKpiForSameEvent)):s.registerForEvent(h(v._details._additionalInfo.et)+"___"+e,i._onReceiveEventForKpi)})))}else s.unregisterFromEvent(m(p._eventType)+"___"+p._details._name,i),s.registerForEvent(m(v._eventType)+"___"+v._details._name,i);i._eventTimes[n]=Date.now()}})),_(this,"_onReceiveEventForTermination",(function(e,t,n,o){var r=H.getInstance();m(i._goalevent._eventType)===e&&i._validateTimeBounds(n,i._goalevent._timeBounds)&&i._goalevent._details._name===t&&i._compareAdditionalInfo(i._goalevent._details._additionalInfo,o)&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._goalevent._count,i._goalevent._countOperator),i._isSatisfied&&(i._goalevent._occurredTime=n,r.validateForTermination(i._uuid,i._index)))})),_(this,"_validatePrecondition",(function(e,t,n,o){var r=i._condition._precondition,a=m(r._eventType)===e&&r._details._name===t&&i._validateTimeBounds(n,r._timeBounds)&&i._compareAdditionalInfo(r._details._additionalInfo,o);return a="APX_PAGE_OPENED"===t?a&&location.pathname===r._details._path:a})),_(this,"_validateTimeBounds",(function(e,t){var i=Math.ceil(e);return i>t._lower&&i<t._upper})),_(this,"_compare",(function(e,t,n){var o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];switch(o&&i._condition._canCheckOldData&&(e+=i._oldEventCount),n){case"EQ":return e===t;case"GT":return e>t;case"GTE":return e>=t;case"LT":return e<t;case"LTE":return e<=t;default:return!1}})),_(this,"_compareAdditionalInfo",(function(e,t){var i=!0;try{var o,r=function(){if(!t[a]||!1===i)return{v:!1};if("object"===n(e[a])){var o,r,_,s=e[a].op,d=e[a].t;"s"===d?_=e[a].val:"l"!==d&&"f"!==d||(_=parseFloat(e[a].val));var c,l=(Array.isArray(t[a])?t[a]:[t[a]]).some((function(e){return y(e,_,s)}));if(!(null===(o=e[a])||void 0===o||!o.present)&&(null===(r=e[a])||void 0===r?void 0:r.present))c=!!t.hasOwn(t,a),i=i&&c;i=i&&l}else i=i&&y(t[a],e[a],"EQ")};for(var a in e)if(o=r())return o.v}catch(e){L.error(e),i=!1}return i})),_(this,"_persistSatisfiedConditions",(function(t,n,o,r,a,_,s,d){console.log("persisting satisfied conditions");var c,l=!1;i.no_KPI_TriggerDetails=e.getController().getFromStorage("apx_nokpi_triggerdetails"),null===i.no_KPI_TriggerDetails||void 0===i.no_KPI_TriggerDetails?i.no_KPI_TriggerDetails=[]:i.no_KPI_TriggerDetails=JSON.parse(i.no_KPI_TriggerDetails);var u,v=0;_&&(v=Date.now()+a);for(var p=0;p<i.no_KPI_TriggerDetails.length;p++)if(i.no_KPI_TriggerDetails[p].id===s){l=!0,c=i.no_KPI_TriggerDetails[p];break}l?c.satisfiedCount+=1:(u={id:s,type:t,time:o,name:n,additionalInfo:r,satisfiedCount:d,timeBased:_,finishTime:v},i.no_KPI_TriggerDetails.push(u)),e.getController().persistToStorage("apx_nokpi_triggerdetails",JSON.stringify(i.no_KPI_TriggerDetails))}))}return a(t,[{key:"_displayCampaign",value:function(e){console.log("in display campaign");var t=H.getInstance();this._isSatisfied=!0,this._isSatisfied&&(this._satisfiedCount+=1,this._isSatisfied=this._compare(this._satisfiedCount,this._condition._count,this._condition._countOperator),this._isSatisfied&&(this._condition._occurredTime=e,t.validate(this._uuid,this._index)))}}]),t}(),P=window.ApxorLogger,G=a((function e(){var t=this;o(this,e),_(this,"_groupValidator",[]),_(this,"_childValidatorsLength",0),_(this,"_andThenChecker",!1),_(this,"initialize",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unordered",r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],a=arguments.length>5?arguments[5]:void 0,_=arguments.length>6&&void 0!==arguments[6]&&arguments[6];t._uuid=i,t._index=n,t._kpi=r,t._respectSequence=o,t.across_sessions=_;var s=[];t._childValidatorsLength=e.length;try{if(null!=s)return o=null==e?void 0:e.sequence_type,s=t.getChildConditions(e,t._childValidatorsLength),"unordered"!==a&&0!==t._index||t.register(),t._groupValidator}catch(e){return P.error(e),!1}})),_(this,"getChildConditions",(function(e,i){for(var n=0;n<i;n++){var o=new k;try{o.initialize(e[n],t._uuid,t._index,t._respectSequence,t._noKpiArray,t.across_sessions,"",-1,!1)&&(t._groupValidator.push(o),t._groupValidator.sequence_type=t._respectSequence)}catch(e){P.error(e)}}return t._groupValidator})),_(this,"register",(function(){if("ordered"===t._respectSequence||"strictly_ordered"===t._respectSequence)t._groupValidator[0].register(0);else{var e,i=l(t._groupValidator);try{for(i.s();!(e=i.n()).done;){e.value.register()}}catch(e){i.e(e)}finally{i.f()}}}))})),j=window.ApxorLogger,U=a((function t(){var i=this;o(this,t),_(this,"_events",[]),_(this,"_ret_day",{}),_(this,"_session",{}),_(this,"_toggleRetDay",!1),_(this,"_toggleSession",!1),_(this,"retainedDaysValidated",!0),_(this,"retainedSessionValidated",!0),_(this,"eventDoneInLT",!1),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{i._events=e.overall_cfg.events,i._ret_day=e.overall_cfg.ret_day,i._session=e.overall_cfg.session,i._toggleRetDay=e.overall_cfg.toggleRetDay,i._toggleSession=e.overall_cfg.toggleSession}catch(e){return j.error(e),!1}return!0})),_(this,"validate",(function(){var t=parseInt(e.getController().getFromStorage("apx_retained_days")),n=parseInt(e.getController().getFromStorage("apx_retained_session"));if(i._toggleRetDay&&!isNaN(t)&&!(t>=i._ret_day.from&&t<=i._ret_day.to))return i.retainedDaysValidated=!1,!1;if(i._toggleSession&&!isNaN(n)&&!(n>=i._session.from&&n<=i._session.to))return i.retainedSessionValidated=!1,!1;try{for(var o=e.getController().getFromStorage("_apx_lt_count"),r=e.getSiteId(),a=JSON.parse((new TextDecoder).decode(function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return t}(f(r,o)))),_=0;_<i._events.length;_++){if(a[i._events[_].name.replace("'","").replace("’","")])return i.eventDoneInLT=!0,!1}}catch(e){j.error("Failed to validate the lt count:"+e)}return!0}))})),B=window.ApxorLogger,M=a((function e(){var t=this;o(this,e),_(this,"_userAttributes",[]),_(this,"_sessionAttributes",[]),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(t._userAttributes=e.attributes.user,t._sessionAttributes=e.attributes.session,!Array.isArray(t._userAttributes)||!Array.isArray(t._sessionAttributes))return B.error("No attributes"),!1}catch(e){return B.error(e),!1}return!0})),_(this,"validate",(function(e,i){return t._compareAttributes(e,t._userAttributes)&&t._compareAttributes(i,t._sessionAttributes)})),_(this,"_compareAttributes",(function(e,t){var i=t.length,n=!0;try{for(var o,r=function(){var i=t[a];if(!e[i.name]||!1===n)return{v:!1};var o=i.operator,r=i.type,_=i.value.map((function(e){return"s"===r?e:"l"===r?parseInt(e):"f"===r?parseFloat(e):void 0})),s=(Array.isArray(e[i.name])?e[i.name]:[e[i.name]]).some((function(e){return _.some((function(t){return y(e,t,o)}))}));n=n&&s},a=0;a<i;a++)if(o=r())return o.v}catch(e){B.error(e),n=!1}return n}))})),Q=a((function t(){var i=this;o(this,t),_(this,"_controller",e.getController()),_(this,"type",""),_(this,"_duration_seconds",0),_(this,"_days",1),_(this,"parse",(function(e){try{var t,n,o;if(i._type=null===(t=e.terminate_info.time_based)||void 0===t?void 0:t.type,i._duration_seconds=null===(n=e.terminate_info)||void 0===n?void 0:n.time_based.duration_seconds,i._days=null===(o=e.terminate_info.time_based)||void 0===o?void 0:o.days,i.compare(e._id))return i._controller.persistTerminationInfoLocally(e._id),!1}catch(e){return!1}return!0})),_(this,"compare",(function(e){var t,n=JSON.parse(i._controller.getFromStorage("apx_termination_ID"));if(!n[e]||null===(t=n[e])||void 0===t||!t.startDate)return!1;var o,r=new Date(n[e].startDate),a=new Date((o=new Date).getMonth()+"/"+o.getDate()+"/"+o.getFullYear()),_=parseInt((a-r)/864e5,10),s=function(){var e=new Date;return{hours:e.getHours(),mins:e.getMinutes()}}(),d=n[e]._startTime;return _===i._days&&s.hours>=d.hours||_>i._days||n[e].goalAcheived}))})),z=a((function e(){var t=this;o(this,e),_(this,"enable_goal_events",!1),_(this,"attributes",{}),_(this,"_attributes",new M),_(this,"_timebasedtermination",new Q),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var i,n,o;if(t.enable_time_based=null==e||null===(i=e.terminate_info)||void 0===i?void 0:i.enable_time_based,t.enable_time_based&&!t._timebasedtermination.parse(e))return!1;if(t.enable_goal_events=null==e||null===(n=e.terminate_info)||void 0===n?void 0:n.enable_goal_events,t.enable_attributes=null==e||null===(o=e.terminate_info)||void 0===o?void 0:o.enable_attributes,t.enable_attributes&&!t._attributes.parse(e.terminate_info))return!1}catch(e){return window.ApxorLogger.error(e),!1}return!0})),_(this,"validate",(function(e,i){return t._attributes.validate(e,i)}))})),Y=window.ApxorLogger,J=a((function t(){var n=this;o(this,t),_(this,"_conditionValidators",[]),_(this,"_terminationGoalEventValidators",[]),_(this,"_uuid",""),_(this,"_meta",new w),_(this,"_audience",new b),_(this,"_validity",new I),_(this,"_frequency",new T),_(this,"_overallconfig",new U),_(this,"_terminationconfig",new z),_(this,"_respectSequence",!1),_(this,"_noKpiArray",[]),_(this,"_variant_code",""),_(this,"_andThenChecker",!1),_(this,"groupCombineOperator","OR"),_(this,"_receivedEventForKpi",!1),_(this,"_kpinextValidator",void 0),_(this,"timeForKPI",void 0),_(this,"kpiIndex",0),_(this,"_nextValidator",void 0),_(this,"_across_sessions",!1),_(this,"_conditionsFromConfig",void 0),_(this,"_advanceConditionsChecker",!1),_(this,"_matchedConditionObject",void 0),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var t,i;if(!v(e._id))return Y.error("No Id"),!1;if(!v(e.enabled)||!e.enabled)return Y.error("Not enabled"),!1;if(!(n._meta.parse(e)&&n._validity.parse(e)&&n._frequency.parse(e)&&n._audience.parse(e)&&n._overallconfig.parse(e)&&n._terminationconfig.parse(e)))return!1;if(n._variant_code=n._meta._isExperiment||n._meta._only_context?null===(t=n._meta._attr)||void 0===t?void 0:t.apx_variant_code:"TG",n._across_sessions=!(null==e||!e.across_sessions)&&(null==e?void 0:e.across_sessions),!v(e.conditions)||!Array.isArray(e.conditions))return Y.error("No valid conditions",e.conditions),!1;n._uuid=e._id,n._respectSequence=!!v(e.sequence_enabled)&&e.sequence_enabled,v(e.conditions_v2)&&(n._respectSequence=null==e?void 0:e.sequence_type),!0===n._respectSequence&&e.conditions.sort((function(e,t){return e.sequence<t.sequence})),v(e.conditions_v2)?(i=e.conditions_v2,n._advanceConditionsChecker=!0):i=e.conditions,n._conditionsFromConfig=i;var o=i.length;if(n.handleConditions(i,o),console.log(n._conditionValidators),console.log("hi"),n.getSequencedConditionsFromStorageandUpdate(),console.log(n._conditionValidators),n._terminationconfig.enable_goal_events)for(var r=e.terminate_info.goal_events.events,a=r.length,_=0;_<a;_++){var s=new k;s.initialize(r[_],n._uuid,_,!0,[],n._across_sessions,"termination")&&n._terminationGoalEventValidators.push(s)}return console.log("conditional validator parse"),n._conditionValidators.length>0}catch(e){return Y.error(e),!1}})),_(this,"handleConditions",(function(e,t){for(var i=0;i<t;i++){n._noKpiArray=[];var o=e[i];if("group"===(null!=o&&o.condition_type?null==o?void 0:o.condition_type:"single")){var r=o.conditions_v2;n.groupCombineOperator=o.combine_operator;var a=null==o?void 0:o.sequence_type,_=new G,d=_.initialize(r,n._uuid,i,a,n._noKpiArray,n._respectSequence,n._across_sessions);n._conditionValidators.push(d),console.log(_)}else{if("didn't"===o.type){var c,l={trigger_key:o.trigger.details.name,no_kpi_array:null==o||null===(c=o.details)||void 0===c||null===(c=c.additional_info)||void 0===c?void 0:c.nkpi,condition_id:null==o?void 0:o._id,time_bounds:o.time_bounds.upper};n._noKpiArray=[].concat(s(n._noKpiArray),[l])}var u=new k;u.initialize(o,n._uuid,i,n._respectSequence,n._noKpiArray,n._across_sessions)&&(n._conditionValidators.push(u),console.log(n._conditionValidators))}}})),_(this,"getSequencedConditionsFromStorageandUpdate",(function(){if(n._across_sessions&&"ordered"===n._respectSequence){console.log("across_sesions_case");var t=e.getController().getFromStorage("apx_nokpi_triggerdetails");if(null!=(t=JSON.parse(t))&&null!=t)for(var i=0;i<n._conditionValidators.length;i++){var o=n.checkConditionsatisfiedStatus(i,t);o?i===n._conditionValidators.length-1&&n._validateAllConditions():o||void 0===!n._conditionValidators[i].length&&n._conditionValidators[i].register()}}})),_(this,"checkConditionsatisfiedStatus",(function(e,t){if(void 0===n._conditionValidators[e].length||1===n._conditionValidators[e].length){var i=n._conditionValidators[e]._condition._id,o=!1,r=n.findObjectById(i,t);if(r)n._matchedConditionObject=r,o=(new k)._compare(r.satisfiedCount,n._conditionValidators[e]._condition._count,n._conditionValidators[e]._condition._countOperator),r&&(o?n._conditionValidators[e]._isSatisfied=!0:n._conditionValidators[e]._satisfiedCount=r.satisfiedCount);return o}if(n._conditionValidators[e].length>=1){var a,_,s;if("ordered"===(_=null===(a=n._conditionValidators[e])||void 0===a?void 0:a.sequence_type)||"strictly_ordered"===_){for(var d=0;d<n._conditionValidators[e].length;d++){var c=n._conditionValidators[e][d],l=c._condition._id;s=!1;var u=n.findObjectById(l,t);if(u)if(s=(new k)._compare(u.satisfiedCount,c._condition._count,c._condition._countOperator),u)if(s){n._conditionValidators[e][d]._isSatisfied=!0;var p=d+1;console.log("nested and then");var g=n._conditionValidators[e][d+1];void 0===g&&v(n._conditionValidators[e+1])&&(n._conditionValidators[e+1].register(),s=!0),null!=g&&n._conditionValidators[e][d+1].register(p)}else n._conditionValidators[e][d]._satisfiedCount=u.satisfiedCount}return s}for(var f=0;f<n._conditionValidators[e].length;f++){var m=n._conditionValidators[e][f],h=m._condition._id;s=!1;var y=n.findObjectById(h,t);if(y)s=(new k)._compare(y.satisfiedCount,m._condition._count,m._condition._countOperator),y&&(s?n._conditionValidators[e][f]._isSatisfied=!0:n._conditionValidators[e][f]._satisfiedCount=y.satisfiedCount);else m.register()}return s}})),_(this,"findObjectById",(function(e,t){return t.find((function(t){return t.id===e}))})),_(this,"evaluate",(function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;console.log("coming to evaluate");var o=H.getInstance();if(!(t<0)){var r=n._conditionValidators[t],a="unordered";if((null==r?void 0:r.length)>1&&(a=null==r?void 0:r.sequence_type),!0===n._respectSequence||"ordered"===n._respectSequence||"strictly_ordered"===n._respectSequence||"ordered"===a||"strictly_ordered"===a){console.log("respect sequence ordered"),n.kpiIndex=t+1;var _=n._conditionValidators[t];if((null==_?void 0:_.length)>0){if(v(_))if("unordered"===n._respectSequence&&"ordered"===a){var s=r[i-1];if(v(s))if(void 0===s.length||1==s.length){if(!s._isSatisfied)return}else if(s.length>1&&!n.validateChildConditions(s))return;var d,c=r[i+1];if(v(c)){if(c.register(i+1),"strictly_ordered"===n._respectSequence){n._currentEventname=_[i]._condition._details._name;var u=e.getController();u.registerForEvent("APP_EVENT",n.immediateEventChecker),u.registerForEvent("CLIENT_EVENT",n.immediateEventChecker)}}else if("strictly_ordered"===a)1!=n._andThenChecker&&n._validateAllConditions();else(null===(d=r[i])||void 0===d?void 0:d.length)>0?n.validateChildConditions(r)&&n._validateAllConditions():n._validateAllConditions()}else{var p,g=n._conditionValidators[t-1];if(v(g))if(void 0===g.length||1==g.length){if(!g._isSatisfied)return}else if(g.length>1&&!n.validateChildConditions(g))return;if(void 0===_.length||1===_.length?p=n._conditionValidators[t+1]:_.length>1&&(p=i===_.length-1?n._conditionValidators[t+1]:n._conditionValidators[t][i+1]),v(p)){if(void 0===p.length||1===p.length?p.register(i+1):n.validateChildConditions(_)&&p.register(),"strictly_ordered"===n._respectSequence){n._currentEventname=_[i]._condition._details._name;var f=e.getController();f.registerForEvent("APP_EVENT",n.immediateEventChecker),f.registerForEvent("CLIENT_EVENT",n.immediateEventChecker)}}else"strictly_ordered"===n._respectSequence?1!=n._andThenChecker&&n._validateAllConditions():n.validateChildConditions(_)&&n._validateAllConditions()}}else if(v(_)&&_._isSatisfied){_._eventTimes[_._condition._details._name]=Date.now();var h=n._conditionValidators[t-1];if(v(h))if(void 0===h.length||1==h.length){if(!h._isSatisfied)return}else if(h.length>1&&!n.validateChildConditions(h))return;var y=n._conditionValidators[t+1];if(v(y)){var C,x;if(null!=y&&null!==(C=y._condition)&&void 0!==C&&C._timeEnabled){if("session"!=(null===(x=y._condition)||void 0===x?void 0:x._time.unit)){var S,b,F=E(y._condition._time.unit,y._condition._time.value);if("didn't"==(null===(S=y._condition)||void 0===S?void 0:S._type)){if(setTimeout((function(){if(!n._receivedEventForKpi&&(y._isSatisfied=!0,y._isSatisfied)){y._satisfiedCount+=1;var e=new k;if(y._isSatisfied=e._compare(y._satisfiedCount,y._condition._count,y._condition._countOperator),console.log("expected here"),y._isSatisfied){y._condition._occurredTime=Date.now();var i=t+1,r=n._conditionValidators[i+1];v(r)?(console.log("registering next condition"),r.register()):n._validateAllConditions()}}o.unregisterFromEvent(m(y._condition._eventType)+"___"+y._condition._details._name,n._onReceiveEventForNoKpi),y._triggered=!1}),F),console.log("expected here"),n._across_sessions){var T=E(y._condition._time.unit,y._condition._time.value),w=y._condition._timeEnabled,A=y._condition._id,I=new k;I._persistSatisfiedConditions(y._condition._type,y._condition._details._name,Date.now(),y._condition._details._additionalInfo,T,w,A)}console.log(y._condition._timeEnabled),"specific_event"===y._condition._eventCategory?o.registerForEvent(m(y._condition._eventType)+"___"+y._condition._details._name,n._onReceiveEventForNoKpi):n.registerForGivenEventCategoryNOkpi(y)}else"did"==(null===(b=y._condition)||void 0===b?void 0:b._type)&&(n._nextValidator=y,setTimeout((function(){o.unregisterFromEvent(m(y._condition._eventType)+"___"+y._condition._details._name,n._onReceiveEventForKpi)}),F),n._kpinextValidator=_,n.timeForKPI=F,o.registerForEvent(m(y._condition._eventType)+"___"+y._condition._details._name,n._onReceiveEventForKpi))}}else if(y.length>0)if("ordered"===y.sequence_type||"unordered"===y.sequence_type)y[0].register(i+1);else{var V,N=l(y);try{for(N.s();!(V=N.n()).done;){var O=V.value;O.register()}}catch(e){N.e(e)}finally{N.f()}}else y.register();if(console.log("validating second condition"),"strictly_ordered"===n._respectSequence){n._currentEventname=_._condition._details._name;var R=e.getController();R.registerForEvent("APP_EVENT",n.immediateEventChecker),R.registerForEvent("CLIENT_EVENT",n.immediateEventChecker)}}else"strictly_ordered"===n._respectSequence?1!=n._andThenChecker&&n._validateAllConditions():n._validateAllConditions()}}else n._getSatisfiedConditionsFromStorageAndUpdate(),console.log(n._conditionValidators),n._validateAllConditions()}})),_(this,"immediateEventChecker",(function(e){e&&e.name!=n._currentEventname&&(n._andThenChecker=!0)})),_(this,"registerForGivenEventCategoryNOkpi",(function(e){var t=new H,i=e._condition._eventCategory;"apxor_event"===i?t.registerForEvent("apxor_event",n._onReceiveEventForNoKpi):"customer_event"===i?t.registerForEvent("customer_event",n._onReceiveEventForNoKpi):"any_event"===i?t.registerForEvent("any_event",n._onReceiveEventForNoKpi):"campaign_event"===i?t.registerForEvent("campaign_event",n._onReceiveEventForNoKpi):"survey_event"===i&&t.registerForEvent("survey_event",n._onReceiveEventForNoKpi)})),_(this,"_onReceiveEventForNoKpi",(function(){console.log("received event of nkpi"),n._receivedEventForKpi=!0})),_(this,"_onReceiveEventForKpi",(function(){console.log("configitem kpi check"),n._receivedEventForKpi=!0;var e=new k;if(n._nextValidator._satisfiedCount+=1,n._nextValidator._isSatisfied=e._compare(n._nextValidator._satisfiedCount,n._nextValidator._condition._count,n._nextValidator._condition._countOperator),n._nextValidator._isSatisfied){var t=n._conditionValidators[n.kpiIndex+1];v(t)?t.register():n._validateAllConditions()}})),_(this,"_getSatisfiedConditionsFromStorageAndUpdate",(function(){if(n._across_sessions&&n._advanceConditionsChecker){var t,i,o,r="single",a=!1,_=e.getController().getFromStorage("apx_nokpi_triggerdetails");if(_=JSON.parse(_),console.log(_),_.length>0){var s,d=l(_);try{var c=function(){var e=s.value;console.log(e);var _=e.id,d=e.satisfiedCount;if(t=n._conditionValidators.find((function(e,t){if(1===(null==e?void 0:e.length)||void 0===(null==e?void 0:e.length)){if(e._condition._id===_)return r="single",!0}else if(e.length>0){var n=e.findIndex((function(e){return e._condition._id===_}));if(-1!==n)return console.log("Matching Condition Index:",t),i=t,console.log("Nested Condition Index:",n),o=n,r="group",!0}return!1})),"single"===r&&t){var c=new k;a=c._compare(d,t._condition._count,t._condition._countOperator);var l=n._conditionValidators.findIndex((function(e){return e._condition._id===_}));a&&(n._conditionValidators[l]._isSatisfied=!0)}else if("group"===r&&t){var u=new k;(a=u._compare(d,t[o]._condition._count,t[o]._condition._countOperator))&&(n._conditionValidators[i][o]._isSatisfied=!0,console.log(n._conditionValidators))}};for(d.s();!(s=d.n()).done;)c()}catch(e){d.e(e)}finally{d.f()}}}})),_(this,"terminationEvaluate",(function(e){e<0||n._validateAllGoalEvents()})),_(this,"_validateAllConditions",(function(){console.log("in validate all conditions");var t=e.getController().getUserAttributes(),o=e.getController().getSessionAttributes();if(!n._validity.validate()||!n._audience.validate(t,o)||!n._overallconfig.validate()){var r="SURVEY"===n._meta._type?"survey":"campaign";return n._overallconfig.retainedDaysValidated||null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"Retained day criteria not met"},!1,"apxor",r),n._overallconfig.retainedSessionValidated||null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"User session criteria not met"},!1,"apxor",r),n._overallconfig.eventDoneInLT&&(null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"Event done in life time"},!1,"apxor",r)),n._audience.userAttributesValidated||null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"User property filter not met"},!1,"apxor",r),n._audience.sessionAttributeValidated||null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"Session property filter not met"},!1,"apxor",r),n._validity._not_yet_active&&(null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"nudge not yet active"},!1,"apxor",r)),void(n._validity._nudge_expired&&(null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"nudge expired"},!1,"apxor",r)))}for(var a=n._conditionValidators.length,_=a<1,s="",d=0;d<a;d++){var c=void 0,l=n._conditionValidators[d];if(l.length>1){c="AND"===l[0]._condition._combineOperator;for(var u=0;u<l.length;u++){c="AND"===l[0]._condition._combineOperator?c&&l[u]._isSatisfied:c||l[u]._isSatisfied}}else c=l._isSatisfied;if(""===s.trim())_=c;else switch(s){case"AND":_=_&&c;break;case"OR":_=_||c}s=l.length>1?n.groupCombineOperator:l._combineOperator}if(_){var v,p;if(console.debug("onCondition satisfied"),!n._frequency.isFrequencyWithInLimits(n._uuid))return console.warn("Maximum limit reached",n._uuid),void(null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:"Campaign limit reached"},!1,"apxor","campaign"));if(!(null!==(v=window.ApxorRTM)&&void 0!==v&&v.isBadgePresent&&null!==(p=window.ApxorRTM)&&void 0!==p&&p.badgesLists.includes(n._uuid)&&e.getController().isBadgeTriggerSatisfied(n._uuid))){var g="SURVEY"===n._meta._type?"survey":"campaign";null==e||e.logEvent("apx_trigger_satisfied",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG"},!1,"",g)}if(console.log("Dispatching event",n._meta._type),n._across_sessions&&localStorage.removeItem("apx_nokpi_triggerdetails"),!0===n._meta._only_context){var f="SURVEY"===n._meta._type?"survey":"campaign";e.logEvent("apx_context_evaluated",i(i({},n._meta._attr),{},{message_name:n._meta._name,id:n._uuid}),!1,"",f)}e.getController().dispatchEvent(n._meta._type,{name:n._meta._type,additional_info:{uuid:n._uuid,name:n._meta._name}})}})),_(this,"_validateAllGoalEvents",(function(){for(var t=n._terminationGoalEventValidators.length,o=t<1,r="",a=0;a<t;a++){var _=n._terminationGoalEventValidators[a],s=_._isSatisfied;if(""===r.trim())o=s;else switch(r){case"AND":o=o&&s;break;case"OR":o=o||s}r=_._conbineOperatorForGoalEvent}if(o){if(console.log("Dispatching event",n._meta._type),e.getController().persistTerminationInfoLocally(n._uuid),!0===n._meta._only_context){var d="SURVEY"===n._meta._type?"survey":"campaign";e.logEvent("apx_context_evaluated",i(i({},n._meta._attr),{},{message_name:n._meta._name,id:n._uuid}),!1,"apxor",d)}e.getController().dispatchEvent(n._meta._type,{name:n._meta._type,additional_info:{uuid:n._uuid,name:n._meta._name}})}})),_(this,"validateForTerminationAttributes",(function(){var t=e.getController().getUserAttributes(),i=e.getController().getSessionAttributes();return n._terminationconfig.validate(t,i)})),_(this,"decrementCampaignCount",(function(){n._frequency.decrementCampaignCount()})),_(this,"getFrequencyCount",(function(){return n._frequency.getFrequencyCount()})),_(this,"resetFrequencyCount",(function(){return n._frequency.resetCampaignCount()})),_(this,"validateChildConditions",(function(e){var t;t="AND"===e[0]._condition._combineOperator;for(var i=0;i<e.length;i++){t="AND"===e[0]._condition._combineOperator?t&&e[i]._isSatisfied:t||e[i]._isSatisfied}return t}))})),$=a((function e(){var t=this;o(this,e),_(this,"_configs",{}),_(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{configs:[]};if(v(e)&&v(e.configs)){var i=e.configs;if(!Array.isArray(i))return;i.sort((function(e,t){var i,n;return(null!==(i=e.prio)&&void 0!==i?i:-1)-(null!==(n=t.prio)&&void 0!==n?n:-1)}));for(var n=0;n<i.length;n++){var o=i[n],r=o._id,a=new J;a.parse(o)?t._configs[r]=a:console.warn("Failed to parse cfg",r)}}})),_(this,"validate",(function(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;if(t._configs[e]){var o=t._configs[e];o.evaluate(i,n)}})),_(this,"getVariantCode",(function(e){return t._configs[e]?t._configs[e]._variant_code:""})),_(this,"validateForTermination",(function(e,i){t._configs[e]&&t._configs[e].terminationEvaluate(i)})),_(this,"validateForTerminationAttributes",(function(e){return!!t._configs[e]&&t._configs[e].validateForTerminationAttributes()})),_(this,"decrementCampaignCount",(function(e){t._configs[e].decrementCampaignCount()})),_(this,"getFrequencyCount",(function(e){return t._configs[e].getFrequencyCount()})),_(this,"resetFrequencyCounts",(function(){var e=t._configs;for(var i in e)e[i].resetFrequencyCount()})),_(this,"getCampaignMeta",(function(e){try{if(t._configs){var i=t._configs[e];if(i&&i._meta)return i._meta}}catch(e){console.log("Error in getting the campaign meta ".concat(e))}return{}}))})),X=window.ApxorLogger,W=a((function t(){var i=this;o(this,t),_(this,"_listeners",{}),_(this,"_buffer",[]),_(this,"_isEnabled",!1),_(this,"initialize",(function(){var t=e.getController();t.registerForEvent("APP_EVENT",(function(e){return i._onEvent(e,"AE")})),t.registerForEvent("CLIENT_EVENT",(function(e){return i._onEvent(e,"CE")}))})),_(this,"enable",(function(){for(var e in i._buffer)i._notifyListeners(e.event,e.key,e.type);i._isEnabled=!0})),_(this,"registerToEvent",(function(e,t){var n;(console.log("register To Event"),"function"==typeof t)&&((n=i._listeners[e]?i._listeners[e]:[]).push(t),i._listeners[e]=n,X.debug("Listeners list: ",i._listeners))})),_(this,"unregisterFromEvent",(function(e,t){if(i._listeners[e]){for(var n=i._listeners[e],o=[],r=0;r<n.length;r++){var a=n[r];a!==t&&o.push(a)}i._listeners[e]=o}})),_(this,"_onEvent",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"AE";i._notifyListeners(e,"any_event",t),"apxor"===(null==e?void 0:e.loggedBy)?(console.log("notifying apxor event listeners"),i._notifyListeners(e,"apxor_event",t)):"customer"===(null==e?void 0:e.loggedBy)&&i._notifyListeners(e,"customer_event",t),"campaign"===(null==e?void 0:e.apx_nudge_type)?i._notifyListeners(e,"campaign_event",t):"survey"===(null==e?void 0:e.apx_nudge_type)&&i._notifyListeners(e,"survey_event",t);var n=t+"___"+e.name;i._notifyListeners(e,n,t)})),_(this,"_notifyListeners",(function(t,n,o){if(i._isEnabled){if(X.debug("Notifying listeners for event: "+t+", "+n,i._listeners),i._listeners[n])for(var r=i._listeners[n],a=e.getController().getSDKRunningTimeInSec(),_=0;_<r.length;_++){(0,r[_])(o,t.name,a,t.additional_info)}}else i._buffer.push({event:t,key:n,type:o})}))})),Z=window.ApxorLogger,H=function(){function t(){var i=this;return o(this,t),_(this,"_isInitialized",!1),_(this,"_configLookup",null),_(this,"_date",x()),_(this,"_eventsListener",new W),_(this,"_siteId",e.getSiteId()),_(this,"_qeState",{}),_(this,"getQeState",(function(){try{var t=e.getController().getFromStorage("qe_state");return t?JSON.parse(f(i._siteId,t)):(i._qeState={},i.setQeState())}catch(e){return i._qeState={},i.setQeState()}})),_(this,"setQeState",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{e.getController().persistToStorage("qe_state",i._qeState,!0)}catch(n){""===t?i._qeState={}:i._qeState[t]={SESSION:0,OVERALL:0,DATES:{}},e.getController().persistToStorage("qe_state",i._qeState,!0)}return i._qeState})),_(this,"initialize",(function(){i._isInitialized||(i._isInitialized=!0,i._configLookup=new $,i._eventsListener.initialize(),i._qeState=i.getQeState(),Z.info("QE Initialized.."))})),_(this,"parse",(function(e){i._check()?(i._configLookup.parse(e),i._eventsListener.enable()):Z.warn("Must call init first. Unable to proceed")})),_(this,"validate",(function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;i._check()&&i._configLookup.validate(e,t,n)})),_(this,"getVariantCode",(function(e){return i._configLookup.getVariantCode(e)})),_(this,"validateForTermination",(function(e,t){i._check()&&i._configLookup.validateForTermination(e,t)})),_(this,"validateForTerminationAttributes",(function(e,t){return i._configLookup.validateForTerminationAttributes(e,t)})),_(this,"updateCount",(function(e){try{v(i._qeState[e])||i.createObjConfig(e),i.incrementFrequencies(e),i.setQeState(e),i._configLookup.decrementCampaignCount(e)}catch(e){console.log("Could not update the count config:".concat(e))}})),_(this,"resetFrequencyCounts",(function(){i._configLookup.resetFrequencyCounts()})),_(this,"getFrequencyCount",(function(e){return i._configLookup.getFrequencyCount(e)})),_(this,"registerForEvent",(function(e,t){console.log("registered event",e),i._eventsListener.registerToEvent(e,t)})),_(this,"unregisterFromEvent",(function(e,t){console.log("in unregister"),i._eventsListener.unregisterFromEvent(e,t)})),_(this,"notifyEventListener",(function(e){i._eventsListener._onEvent(e)})),_(this,"fetch",(function(t,i,n,o){e.getController().fetchConfiguration(t,i,n,o)})),_(this,"_check",(function(){return i._isInitialized})),_(this,"getCampaignMetaFromQueryEngine",(function(e){return i._configLookup.getCampaignMeta(e)})),_(this,"getCEStartDate",(function(){return i._date})),t.instance||(t.instance=this),t.instance}return a(t,[{key:"createObjConfig",value:function(e){try{this._qeState=this.getQeState(),v(this._qeState[e])||(this._qeState[e]={SESSION:0,OVERALL:0,DATES:{}},this._date&&(this._qeState[e].DATES[this._date]=0),this.setQeState(e))}catch(e){Z.error("Can not create the frequency count object:"+e)}}},{key:"incrementFrequencies",value:function(e){this._qeState=this.getQeState();var t=this._qeState[e];t.SESSION=t.SESSION+1,t.OVERALL=t.OVERALL+1;var i=x();i===this._date&&t.DATES&&t.DATES[i]||(this._date=i,t.DATES={},t.DATES[this._date]=0),t.DATES[this._date]=t.DATES[this._date]+1}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}();_(H,"instance",void 0),window.ceVersion=151;try{void 0===exports&&null===exports||(exports.default=H,module.exports=exports.default)}catch(e){}return H}));
