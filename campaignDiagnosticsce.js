!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("apxor")):"function"==typeof define&&define.amd?define(["apxor"],t):(e=e||self)["apxor-qe"]=t(e.Apxor)}(this,(function(e){"use strict";function t(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function i(e){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?t(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,c(n.key),n)}}function a(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t,i){return(t=c(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return u(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var d=function(e){return void 0!==e&&!function(e){return null===e}(e)},l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function v(e,t){return Array.from(t).map((function(t,i){return String.fromCharCode(t^function(e,t){return e.charCodeAt(Math.floor(t%e.length))}(e,i))})).join("")}var f=function(e,t){return v(e,t=function(e){var t,i,n,r,o,a,s=0,_=[];if(!e)return e;e+="";do{t=(a=l.indexOf(e.charAt(s++))<<18|l.indexOf(e.charAt(s++))<<12|(r=l.indexOf(e.charAt(s++)))<<6|(o=l.indexOf(e.charAt(s++))))>>16&255,i=a>>8&255,n=255&a,_.push(t),64!==r&&(_.push(i),64!==o&&_.push(n))}while(s<e.length);return _}(t))},p=function(e){switch(e){case"app_event":return"AE";case"client_event":return"CE";case"activity_time":case"activity_event":return"AE"}return"Unknown"},g=function(e){return e.toUpperCase()},h=function(e,t,i){switch(i){case"EQ":return e===t;case"GT":return e>t;case"GTE":return e>=t;case"LT":return e<t;case"LTE":return e<=t;case"NEQ":return e!==t;case"R":return m(t).test(e);default:return!1}},m=function(e){var t=e.replace(/.*\/([gimuy]*)$/,"$1");t===e&&(t="");var i=t?e.replace(new RegExp("^/(.*?)/"+t+"$"),"$1"):e;return new RegExp(i,t)},y=function(){var e=new Date;return e.getDate()+"/"+e.getMonth()+"/"+e.getFullYear()},b=window.ApxorLogger,E=a((function t(){var i=this;r(this,t),s(this,"_type","ALL"),s(this,"_userAttributes",[]),s(this,"_sessionAttributes",[]),s(this,"userAttributesValidated",!0),s(this,"sessionAttributeValidated",!0),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(i._type=e.audience.audience_type,i._userAttributes=e.audience.attributes.user,i._sessionAttributes=e.audience.attributes.session,!Array.isArray(i._userAttributes)||!Array.isArray(i._sessionAttributes))return b.error("No attributes"),!1}catch(e){return b.error(e),!1}return!0})),s(this,"validate",(function(t,n){var r=!0;"FTU"===i._type&&(r=e.getController().getSessionInfo().is_first_session);var o=i._compareAttributes(t,i._userAttributes),a=i._compareAttributes(n,i._sessionAttributes);return o||(i.userAttributesValidated=!1),a||(i.sessionAttributeValidated=!1),r&&o&&a})),s(this,"_compareAttributes",(function(e,t){var i=t.length,n=!0;try{for(var r,o=function(){var i=t[a];if(void 0===e[i.name]||!1===n)return{v:!1};var r=i.operator,o=i.type,s=i.value.map((function(e){if("s"===o)return e;if("l"===o)return parseInt(e);if("f"===o)return parseFloat(e);if("b"===o)switch(e){case"true":return!0;case"false":return!1}})),_=(Array.isArray(e[i.name])?e[i.name]:[e[i.name]]).some((function(e){return s.some((function(t){return"s"===o?e="".concat(e):"l"===o?e=parseInt(e):"f"===o?e=parseFloat(e):"b"===o&&(e=!!e),h(e,t,r)}))}));n=n&&_},a=0;a<i;a++)if(r=o())return r.v}catch(e){b.error(e),n=!1}return n}))})),S=window.ApxorLogger,A=a((function t(){var i=this;r(this,t),s(this,"_count",0),s(this,"_timeInterval",0),s(this,"_validity","SESSION"),s(this,"_shownCount",0),s(this,"_sessionCount",0),s(this,"_originalCount",0),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{i._uuid=e._id,i._meta=e.meta,i._count=e.frequency.count,-1===i._count&&(i._count=1e3),i._originalCount=i._count,i._timeInterval=e.frequency.time_interval,i._validity=e.frequency.validity,i._sessionCount=e.frequency.ses_lmt,i._dayCount=e.frequency.day_lmt;var t=$.getInstance().getQeState();if(!d(t)||!d(t[e._id]))return!0;if("SESSION"===i._validity){if(i._count=parseInt(i._count)-parseInt(t[e._id].SESSION),i._count<=0)return i.logNonEligibleUserEvent("Session limit reached"),console.warn("Max count limit reached for session:"+e._id),!1}else{if("OVERALL"!==i._validity)return S.info("Invalid config."),!1;if(i._count=parseInt(i._count)-parseInt(t[e._id].OVERALL),i._count<=0)return i.logNonEligibleUserEvent("Overall limit reached"),console.warn("Max count limit reached for overall:"+e._id),!1}}catch(e){return S.error(e),!1}return!0})),s(this,"decrementCampaignCount",(function(){i._count=i._count-1})),s(this,"getFrequencyCount",(function(){return i._count})),s(this,"resetCampaignCount",(function(){"SESSION"===i._validity&&(i._count=i._originalCount,S.info("Campaign Limit reset"))})),s(this,"isFrequencyWithInLimits",(function(e){try{if(i._count<=0)return"OVERALL"===i._validity?i.logNonEligibleUserEvent("Overall limit reached"):"SESSION"===i._validity&&i.logNonEligibleUserEvent("Session limit reached"),!1;var t=$.getInstance().getQeState();if(!d(t)||!d(t[e]))return!0;if(0!==i._sessionCount)if(parseInt(i._sessionCount)-parseInt(t[e].SESSION)<=0)return i.logNonEligibleUserEvent("Session limit reached"),!1;if(0!==i._dayCount){var n,r=y();if(parseInt(i._dayCount)-parseInt((null===(n=t[e])||void 0===n?void 0:n.DATES[r])||0)<=0)return i.logNonEligibleUserEvent("Day limit reached"),!1}}catch(e){i.logNonEligibleUserEvent("Error validating the frequency: ".concat(e)),S.error("Error validating the frequency:"+e)}return!0})),s(this,"logNonEligibleUserEvent",(function(t){var n;null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===i._meta.type?"survey":"campaign",apx_nudge_id:i._uuid,apx_nudge_name:i._meta.name,apx_variant_code:i._meta.isExperiment||i._meta.only_context?null===(n=i._meta.attr)||void 0===n?void 0:n.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:t})}))})),w=a((function e(){var t=this;r(this,e),s(this,"_name",""),s(this,"_type",""),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var i,n;t._name=e.meta.name,t._type=e.meta.type,t._only_context=e.meta.only_context,t._attr=(null===(i=e.meta)||void 0===i?void 0:i.attr)||{},t._isExperiment=null===(n=e.meta)||void 0===n?void 0:n.isExperiment}catch(e){return window.ApxorLogger.error(e),!1}return!0}))})),T=window.ApxorLogger,C=a((function e(){var t=this;r(this,e),s(this,"_startDate",-1),s(this,"_endDate",-1),s(this,"_startTime",-1),s(this,"_endTime",-1),s(this,"_timeLimits",!1),s(this,"_nudge_expired",!1),s(this,"_not_yet_active",!1),s(this,"_not_in_specified_time",!1),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(isNaN(Date.parse(e.validity.start_date))||isNaN(Date.parse(e.validity.end_date)))return T.error("Not valid dates"),!1;if(t._startDate=Date.parse(e.validity.start_date),t._endDate=Date.parse(e.validity.end_date),d(e.at_specific_time)&&(t._timeLimits=e.at_specific_time,t._timeLimits&&d(e.time_limits))){var i=(new Date).toISOString().split("T")[0];if(t._startTime=Date.parse(i+"T"+e.time_limits.start_time+":00.000Z"),t._endTime=Date.parse(i+"T"+e.time_limits.end_time+":00.000Z"),isNaN(t._startTime)||isNaN(t._endTime))return T.error("Not valid times"),!1}}catch(e){return T.error(e),!1}return!0})),s(this,"validate",(function(){var e=Date.now();return e>t._startDate&&e<t._endDate?(!t._timeLimits||e>=t._startTime&&e<=t._endTime||(t._not_in_specified_time=!0),!t._timeLimits||e>=t._startTime&&e<=t._endTime):(e<t._startDate?t._not_yet_active=!0:e>t._endDate&&(t._nudge_expired=!0),!1)}))})),x=a((function e(){var t=this;r(this,e),s(this,"_name",""),s(this,"_additionalInfo",{}),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{t._name=e.name,t._additionalInfo=e.additional_info}catch(e){return!1}return!0}))})),I=a((function e(){var t=this;r(this,e),s(this,"_lower",0),s(this,"_upper",0),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(t._lower=Number(e.lower),t._upper=Number(e.upper),isNaN(t._lower)||isNaN(t._upper))return!1}catch(e){return!1}return!0}))})),O=a((function e(){var t=this;r(this,e),s(this,"_occurredTime",0),s(this,"_eventType",""),s(this,"_navigation",""),s(this,"_details",new x),s(this,"_timeBounds",new I),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{return t._eventType=e.event_type,t._navigation=e.activity,t._details.parse(e.details)&&t._timeBounds.parse(e.time_bounds)}catch(e){return!1}}))})),F=window.ApxorLogger,L=a((function e(){var t=this;r(this,e),s(this,"_occurredTime",0),s(this,"_sequence",-1),s(this,"_count",0),s(this,"_countOperator",""),s(this,"_navigation",""),s(this,"_eventType",""),s(this,"_timeBounds",new I),s(this,"_details",new x),s(this,"_precondition",new O),s(this,"_combineOperator","AND"),s(this,"_canCheckOldData",!1),s(this,"_type",void 0),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{return t._sequence=e.sequence,t._count=e.count_config.count,t._countOperator=e.count_config.operator,t._navigation=e.activity,t._eventType=e.event_type,t._combineOperator=e.combine_operator,t._type=e.type,t._details.parse(e.details)&&t._precondition.parse(e.trigger)&&t._timeBounds.parse(e.time_bounds)}catch(e){return F.error(e),!1}}))})),D=window.ApxorLogger,N=a((function e(){var t=this;r(this,e),s(this,"_count",0),s(this,"_countOperator",""),s(this,"_eventType",""),s(this,"_timeBounds",new I),s(this,"_details",new x),s(this,"_combineOperator","AND"),s(this,"parse",(function(e){try{return t._count=e.count_config.count,t._countOperator=e.count_config.operator,t._eventType=e.event_type,t._combineOperator=e.combine_operator,t._details.parse(e.details)&&t._timeBounds.parse(e.time_bounds)}catch(e){return D.error(e),!1}}))})),q=window.ApxorLogger,k=function(){function t(){var i=this;r(this,t),s(this,"_satisfiedCount",0),s(this,"_uuid",""),s(this,"_condition",new L),s(this,"_goalevent",new N),s(this,"_triggered",!1),s(this,"_isSatisfied",!1),s(this,"_index",0),s(this,"_combineOperator","AND"),s(this,"_conbineOperatorForGoalEvent","OR"),s(this,"_oldEventCount",-1),s(this,"_kpi",[]),s(this,"_eventTimes",{}),s(this,"_receivedEventForKpi",!1),s(this,"initialize",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";if(i._uuid=n,i._index=r,i._kpi=a,"termination"===s&&""!==s){i._goalevent.parse(t);return i._conbineOperatorForGoalEvent=i._goalevent._combineOperator,i.registerForTermination(),!0}var _=i._condition.parse(t);if(_){if(i._combineOperator=i._condition._combineOperator,i._condition._canCheckOldData){var u=i._condition._details._name;"APX_PAGE_OPENED"===u&&(u=i._condition._details._additionalInfo.navigation_id,u=d(u)?u:i._condition._details._name),i._oldEventCount=e.getController().getEventCount(u);var c=i._condition._count,l=i._condition._countOperator;if(i._isSatisfied=i._compare(i._oldEventCount-1,c,l,!1),i._triggered=i._isSatisfied,i._isSatisfied&&"APX_PAGE_OPENED"===i._condition._details._name)return!0}return o&&0!==r||i.register(),!0}return!1})),s(this,"register",(function(){var e,t=i._condition,n=t._precondition,r=$.getInstance();"app_start"===n._eventType?(i._triggered=!0,r.registerForEvent(p(t._eventType)+"___"+t._details._name,i._onReceiveEvent)):r.registerForEvent(p(t._eventType)+"___"+n._details._name,i._onReceiveEvent),null!==(e=window.ApxorRTM)&&void 0!==e&&e.badgesLists.includes(i._uuid)&&r.registerForEvent(p(t._eventType)+"___"+"apxor-badge-container-".concat("-".concat(i._uuid).replaceAll(" ","").replace(/[^\w\s]/gi,"")),i._onReceiveEvent)})),s(this,"registerForTermination",(function(){var e=i._goalevent,t=$.getInstance();i._triggered=!0,t.registerForEvent(p(e._eventType)+"___"+e._details._name,i._onReceiveEventForTermination)})),s(this,"_onReceiveEventForKpiForSameEvent",(function(e,t,n,r){var o,a=(Date.now()-i._eventTimes[t])/1e3;(null===(o=i._condition)||void 0===o||null===(o=o._details)||void 0===o||null===(o=o._additionalInfo)||void 0===o?void 0:o.time)/1e3>a&&i._displayCampaign(n)})),s(this,"_onReceiveEventForKpi",(function(e,t,n,r){var o,a;i._receivedEventForKpi=!0;var s=Date.now(),_=null===(o=i._condition)||void 0===o||null===(o=o._precondition)||void 0===o?void 0:o._details._name,u=(s-i._eventTimes[_])/1e3,c=null===(a=i._condition)||void 0===a||null===(a=a._details)||void 0===a||null===(a=a._additionalInfo)||void 0===a?void 0:a.time;(c/=1e3)>u&&i._displayCampaign(n)})),s(this,"_onReceiveEvent",(function(t,n,r,o){var a,s,_=$.getInstance();if(i._triggered){if(null!==(a=window.ApxorRTM)&&void 0!==a&&a.isBadgePresent&&null!==(s=window.ApxorRTM)&&void 0!==s&&s.badgesLists.includes(i._uuid)&&e.getController().isBadgeTriggerSatisfied(i._uuid))return i._isSatisfied=!0,i._condition._occurredTime=r,void _.validate(i._uuid,i._index);p(i._condition._eventType)===t&&i._validateTimeBounds(r-i._condition._precondition._occurredTime,i._condition._timeBounds)&&i._condition._details._name===n&&i._compareAdditionalInfo(i._condition._details._additionalInfo,o)&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&(i._condition._occurredTime=r,_.validate(i._uuid,i._index)))}else if(i._triggered=i._validatePrecondition(t,n,r,o),i._triggered){var u=i._condition,c=u._precondition;if(c._occurredTime=r,"activity_time"===(null==u?void 0:u._eventType)){var d,l,v,f=null==u||null===(d=u._details)||void 0===d||null===(d=d._additionalInfo)||void 0===d?void 0:d.time;(null==u||null===(l=u._details)||void 0===l||null===(l=l._additionalInfo)||void 0===l?void 0:l.nkpi.length)>0&&(setTimeout((function(){i._receivedEventForKpi||(i._isSatisfied=!0,i._isSatisfied&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._condition._count,i._condition._countOperator),i._isSatisfied&&(i._condition._occurredTime=r,_.validate(i._uuid,i._index)))),u._details._additionalInfo.nkpi.map((function(e){_.unregisterFromEvent(g(u._details._additionalInfo.et)+"___"+e,i)}))}),f),u._details._additionalInfo.nkpi.map((function(e){_.registerForEvent(g(u._details._additionalInfo.et)+"___"+e,i._onReceiveEventForKpi)}))),(null==u||null===(v=u._details)||void 0===v||null===(v=v._additionalInfo)||void 0===v?void 0:v.kpi.length)>0&&(setTimeout((function(){u._details._additionalInfo.kpi.map((function(e){_.unregisterFromEvent(g(u._details._additionalInfo.et)+"___"+e,i)}))}),f),u._details._additionalInfo.kpi.map((function(e){e===u._precondition._details._name?(_.unregisterFromEvent(p(c._eventType)+"___"+c._details._name,i),_.registerForEvent(g(u._details._additionalInfo.et)+"___"+e,i._onReceiveEventForKpiForSameEvent)):_.registerForEvent(g(u._details._additionalInfo.et)+"___"+e,i._onReceiveEventForKpi)})))}else _.unregisterFromEvent(p(c._eventType)+"___"+c._details._name,i),_.registerForEvent(p(u._eventType)+"___"+u._details._name,i);i._eventTimes[n]=Date.now()}})),s(this,"_onReceiveEventForTermination",(function(e,t,n,r){var o=$.getInstance();p(i._goalevent._eventType)===e&&i._validateTimeBounds(n,i._goalevent._timeBounds)&&i._goalevent._details._name===t&&i._compareAdditionalInfo(i._goalevent._details._additionalInfo,r)&&(i._satisfiedCount+=1,i._isSatisfied=i._compare(i._satisfiedCount,i._goalevent._count,i._goalevent._countOperator),i._isSatisfied&&(i._goalevent._occurredTime=n,o.validateForTermination(i._uuid,i._index)))})),s(this,"_validatePrecondition",(function(e,t,n,r){var o=i._condition._precondition;return p(o._eventType)===e&&o._details._name===t&&i._validateTimeBounds(n,o._timeBounds)&&i._compareAdditionalInfo(o._details._additionalInfo,r)})),s(this,"_validateTimeBounds",(function(e,t){var i=Math.ceil(e);return i>t._lower&&i<t._upper})),s(this,"_compare",(function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];switch(r&&i._condition._canCheckOldData&&(e+=i._oldEventCount),n){case"EQ":return e===t;case"GT":return e>t;case"GTE":return e>=t;case"LT":return e<t;case"LTE":return e<=t;default:return!1}})),s(this,"_compareAdditionalInfo",(function(e,t){var i=!0;try{var r,o=function(){if(!t[a]||!1===i)return{v:!1};if("object"===n(e[a])){var r,o=e[a].op,s=e[a].t;"s"===s?r=e[a].val:"l"!==s&&"f"!==s||(r=parseFloat(e[a].val));var _=(Array.isArray(t[a])?t[a]:[t[a]]).some((function(e){return h(e,r,o)}));i=i&&_}else i=i&&h(t[a],e[a],"EQ")};for(var a in e)if(r=o())return r.v}catch(e){q.error(e),i=!1}return i}))}return a(t,[{key:"_displayCampaign",value:function(e){var t=$.getInstance();this._isSatisfied=!0,this._isSatisfied&&(this._satisfiedCount+=1,this._isSatisfied=this._compare(this._satisfiedCount,this._condition._count,this._condition._countOperator),this._isSatisfied&&(this._condition._occurredTime=e,t.validate(this._uuid,this._index)))}}]),t}(),V=window.ApxorLogger,R=a((function t(){var i=this;r(this,t),s(this,"_events",[]),s(this,"_ret_day",{}),s(this,"_session",{}),s(this,"_toggleRetDay",!1),s(this,"_toggleSession",!1),s(this,"retainedDaysValidated",!0),s(this,"retainedSessionValidated",!0),s(this,"eventDoneInLT",!1),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{i._events=e.overall_cfg.events,i._ret_day=e.overall_cfg.ret_day,i._session=e.overall_cfg.session,i._toggleRetDay=e.overall_cfg.toggleRetDay,i._toggleSession=e.overall_cfg.toggleSession}catch(e){return V.error(e),!1}return!0})),s(this,"validate",(function(){var t=parseInt(e.getController().getFromStorage("apx_retained_days")),n=parseInt(e.getController().getFromStorage("apx_retained_session"));if(i._toggleRetDay&&!isNaN(t)&&!(t>=i._ret_day.from&&t<=i._ret_day.to))return i.retainedDaysValidated=!1,!1;if(i._toggleSession&&!isNaN(n)&&!(n>=i._session.from&&n<=i._session.to))return i.retainedSessionValidated=!1,!1;try{for(var r=e.getController().getFromStorage("_apx_lt_count"),o=e.getSiteId(),a=JSON.parse((new TextDecoder).decode(function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return t}(f(o,r)))),s=0;s<i._events.length;s++){if(a[i._events[s].name.replace("'","").replace("â€™","")])return i.eventDoneInLT=!0,!1}}catch(e){V.error("Failed to validate the lt count:"+e)}return!0}))})),U=window.ApxorLogger,j=a((function e(){var t=this;r(this,e),s(this,"_userAttributes",[]),s(this,"_sessionAttributes",[]),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{if(t._userAttributes=e.attributes.user,t._sessionAttributes=e.attributes.session,!Array.isArray(t._userAttributes)||!Array.isArray(t._sessionAttributes))return U.error("No attributes"),!1}catch(e){return U.error(e),!1}return!0})),s(this,"validate",(function(e,i){return t._compareAttributes(e,t._userAttributes)&&t._compareAttributes(i,t._sessionAttributes)})),s(this,"_compareAttributes",(function(e,t){var i=t.length,n=!0;try{for(var r,o=function(){var i=t[a];if(!e[i.name]||!1===n)return{v:!1};var r=i.operator,o=i.type,s=i.value.map((function(e){return"s"===o?e:"l"===o?parseInt(e):"f"===o?parseFloat(e):void 0})),_=(Array.isArray(e[i.name])?e[i.name]:[e[i.name]]).some((function(e){return s.some((function(t){return h(e,t,r)}))}));n=n&&_},a=0;a<i;a++)if(r=o())return r.v}catch(e){U.error(e),n=!1}return n}))})),P=a((function t(){var i=this;r(this,t),s(this,"_controller",e.getController()),s(this,"type",""),s(this,"_duration_seconds",0),s(this,"_days",1),s(this,"parse",(function(e){try{var t,n,r;if(i._type=null===(t=e.terminate_info.time_based)||void 0===t?void 0:t.type,i._duration_seconds=null===(n=e.terminate_info)||void 0===n?void 0:n.time_based.duration_seconds,i._days=null===(r=e.terminate_info.time_based)||void 0===r?void 0:r.days,i.compare(e._id))return i._controller.persistTerminationInfoLocally(e._id),!1}catch(e){return!1}return!0})),s(this,"compare",(function(e){var t,n=JSON.parse(i._controller.getFromStorage("apx_termination_ID"));if(!n[e]||null===(t=n[e])||void 0===t||!t.startDate)return!1;var r,o=new Date(n[e].startDate),a=new Date((r=new Date).getMonth()+"/"+r.getDate()+"/"+r.getFullYear()),s=parseInt((a-o)/864e5,10),_=function(){var e=new Date;return{hours:e.getHours(),mins:e.getMinutes()}}(),u=n[e]._startTime;return s===i._days&&_.hours>=u.hours||s>i._days||n[e].goalAcheived}))})),G=a((function e(){var t=this;r(this,e),s(this,"enable_goal_events",!1),s(this,"attributes",{}),s(this,"_attributes",new j),s(this,"_timebasedtermination",new P),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var i,n,r;if(t.enable_time_based=null==e||null===(i=e.terminate_info)||void 0===i?void 0:i.enable_time_based,t.enable_time_based&&!t._timebasedtermination.parse(e))return!1;if(t.enable_goal_events=null==e||null===(n=e.terminate_info)||void 0===n?void 0:n.enable_goal_events,t.enable_attributes=null==e||null===(r=e.terminate_info)||void 0===r?void 0:r.enable_attributes,t.enable_attributes&&!t._attributes.parse(e.terminate_info))return!1}catch(e){return window.ApxorLogger.error(e),!1}return!0})),s(this,"validate",(function(e,i){return t._attributes.validate(e,i)}))})),B=window.ApxorLogger,M=a((function t(){var n=this;r(this,t),s(this,"_conditionValidators",[]),s(this,"_terminationGoalEventValidators",[]),s(this,"_uuid",""),s(this,"_meta",new w),s(this,"_audience",new E),s(this,"_validity",new C),s(this,"_frequency",new A),s(this,"_overallconfig",new R),s(this,"_terminationconfig",new G),s(this,"_respectSequence",!1),s(this,"_noKpiArray",[]),s(this,"_variant_code",""),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var t;if(!d(e._id))return B.error("No Id"),!1;if(!d(e.enabled)||!e.enabled)return B.error("Not enabled"),!1;if(!(n._meta.parse(e)&&n._validity.parse(e)&&n._frequency.parse(e)&&n._audience.parse(e)&&n._overallconfig.parse(e)&&n._terminationconfig.parse(e)))return!1;if(n._variant_code=n._meta._isExperiment||n._meta._only_context?null===(t=n._meta._attr)||void 0===t?void 0:t.apx_variant_code:"TG",!d(e.conditions)||!Array.isArray(e.conditions))return B.error("No valid conditions",e.conditions),!1;n._uuid=e._id,n._respectSequence=!!d(e.sequence_enabled)&&e.sequence_enabled,n._respectSequence&&e.conditions.sort((function(e,t){return e.sequence<t.sequence}));for(var i=e.conditions,r=i.length,o=0;o<r;o++){n._noKpiArray=[];var a=i[o];if("didn't"===a.type){var s,u={trigger_key:a.trigger.details.name,no_kpi_array:null==a||null===(s=a.details)||void 0===s||null===(s=s.additional_info)||void 0===s?void 0:s.nkpi,condition_id:null==a?void 0:a._id,time_bounds:a.time_bounds.upper};n._noKpiArray=[].concat(_(n._noKpiArray),[u])}var c=new k;c.initialize(a,n._uuid,o,n._respectSequence,n._noKpiArray)&&n._conditionValidators.push(c)}if(n._terminationconfig.enable_goal_events)for(var l=e.terminate_info.goal_events.events,v=l.length,f=0;f<v;f++){var p=new k;p.initialize(l[f],n._uuid,f,!0,[],"termination")&&n._terminationGoalEventValidators.push(p)}return n._conditionValidators.length>0}catch(e){return B.error(e),!1}})),s(this,"evaluate",(function(e){if(!(e<0))if(n._respectSequence){var t=n._conditionValidators[e];if(d(t)&&t._isSatisfied){var i=n._conditionValidators[e-1];if(d(i)&&!i._isSatisfied)return;var r=n._conditionValidators[e+1];d(r)?r.register():n._validateAllConditions()}}else n._validateAllConditions()})),s(this,"terminationEvaluate",(function(e){e<0||n._validateAllGoalEvents()})),s(this,"_validateAllConditions",(function(){var t,r,o=e.getController().getUserAttributes(),a=e.getController().getSessionAttributes();if(null!==(t=window.ApxorRTM)&&void 0!==t&&t.isBadgePresent&&null!==(r=window.ApxorRTM)&&void 0!==r&&r.badgesLists.includes(n._uuid)&&e.getController().isBadgeTriggerSatisfied(n._uuid)||null==e||e.logEvent("apx_trigger_satisfied",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG"}),!n._validity.validate()||!n._audience.validate(o,a)||!n._overallconfig.validate())return n._overallconfig.retainedDaysValidated||n.logNonEligibleUserEvent("Retained day criteria not met"),n._overallconfig.retainedSessionValidated||n.logNonEligibleUserEvent("User session criteria not met"),n._overallconfig.eventDoneInLT&&n.logNonEligibleUserEvent("Event done in life time"),n._audience.userAttributesValidated||n.logNonEligibleUserEvent("User property filter not met"),n._audience.sessionAttributeValidated||n.logNonEligibleUserEvent("Session property filter not met"),n._validity._not_in_specified_time&&n.logNonEligibleUserEvent("Time limits check failed"),n._validity._not_yet_active&&n.logNonEligibleUserEvent("not in the scheduled time"),void(n._validity._nudge_expired&&n.logNonEligibleUserEvent("nudge expired"));for(var s=n._conditionValidators.length,_=s<1,u="",c=0;c<s;c++){var d=n._conditionValidators[c],l=d._isSatisfied;if(""===u.trim())_=l;else switch(u){case"AND":_=_&&l;break;case"OR":_=_||l}u=d._combineOperator}if(_){if(console.debug("onCondition satisfied"),!n._frequency.isFrequencyWithInLimits(n._uuid))return void console.warn("Maximum limit reached",n._uuid);console.log("Dispatching event",n._meta._type),e.logEvent("apx_context_evaluated",i(i({apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?n._meta._attr.apx_variant_code:"TG"},n._meta._attr),{},{message_name:n._meta._name,id:n._uuid})),e.getController().dispatchEvent(n._meta._type,{name:n._meta._type,additional_info:{uuid:n._uuid,name:n._meta._name}})}})),s(this,"_validateAllGoalEvents",(function(){for(var t=n._terminationGoalEventValidators.length,r=t<1,o="",a=0;a<t;a++){var s=n._terminationGoalEventValidators[a],_=s._isSatisfied;if(""===o.trim())r=_;else switch(o){case"AND":r=r&&_;break;case"OR":r=r||_}o=s._conbineOperatorForGoalEvent}r&&(console.log("Dispatching event",n._meta._type),e.getController().persistTerminationInfoLocally(n._uuid),!0===n._meta._only_context&&e.logEvent("apx_context_evaluated",i(i({},n._meta._attr),{},{message_name:n._meta._name,id:n._uuid})),e.getController().dispatchEvent(n._meta._type,{name:n._meta._type,additional_info:{uuid:n._uuid,name:n._meta._name}}))})),s(this,"validateForTerminationAttributes",(function(){var t=e.getController().getUserAttributes(),i=e.getController().getSessionAttributes();return n._terminationconfig.validate(t,i)})),s(this,"decrementCampaignCount",(function(){n._frequency.decrementCampaignCount()})),s(this,"getFrequencyCount",(function(){return n._frequency.getFrequencyCount()})),s(this,"resetFrequencyCount",(function(){return n._frequency.resetCampaignCount()})),s(this,"logNonEligibleUserEvent",(function(t){var i;null==e||e.logEvent("apx_non_eligible_user",{apx_nudge_type:"SURVEY"===n._meta._type?"survey":"campaign",apx_nudge_id:n._uuid,apx_nudge_name:n._meta._name,apx_variant_code:n._meta._isExperiment||n._meta._only_context?null===(i=n._meta._attr)||void 0===i?void 0:i.apx_variant_code:"TG",apx_failure_type:"warn",apx_reason:t})}))})),Q=a((function e(){var t=this;r(this,e),s(this,"_configs",{}),s(this,"parse",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{configs:[]};if(d(e)&&d(e.configs)){var i=e.configs;if(!Array.isArray(i))return;i.sort((function(e,t){var i,n;return(null!==(i=e.prio)&&void 0!==i?i:-1)-(null!==(n=t.prio)&&void 0!==n?n:-1)}));for(var n=0;n<i.length;n++){var r=i[n],o=r._id,a=new M;a.parse(r)?t._configs[o]=a:console.warn("Failed to parse cfg",o)}}})),s(this,"validate",(function(e,i){t._configs[e]&&t._configs[e].evaluate(i)})),s(this,"getVariantCode",(function(e){return t._configs[e]?t._configs[e]._variant_code:""})),s(this,"validateForTermination",(function(e,i){t._configs[e]&&t._configs[e].terminationEvaluate(i)})),s(this,"validateForTerminationAttributes",(function(e){return!!t._configs[e]&&t._configs[e].validateForTerminationAttributes()})),s(this,"decrementCampaignCount",(function(e){t._configs[e].decrementCampaignCount()})),s(this,"getFrequencyCount",(function(e){return t._configs[e].getFrequencyCount()})),s(this,"resetFrequencyCounts",(function(){var e=t._configs;for(var i in e)e[i].resetFrequencyCount()})),s(this,"getCampaignMeta",(function(e){try{if(t._configs){var i=t._configs[e];if(i&&i._meta)return i._meta}}catch(e){console.log("Error in getting the campaign meta ".concat(e))}return{}}))})),K=window.ApxorLogger,z=a((function t(){var i=this;r(this,t),s(this,"_listeners",{}),s(this,"_buffer",[]),s(this,"_isEnabled",!1),s(this,"initialize",(function(){var t=e.getController();t.registerForEvent("APP_EVENT",(function(e){return i._onEvent(e,"AE")})),t.registerForEvent("CLIENT_EVENT",(function(e){return i._onEvent(e,"CE")}))})),s(this,"enable",(function(){for(var e in i._buffer)i._notifyListeners(e.event,e.key,e.type);i._isEnabled=!0})),s(this,"registerToEvent",(function(e,t){var n;"function"==typeof t&&((n=i._listeners[e]?i._listeners[e]:[]).push(t),i._listeners[e]=n,K.debug("Listeners list: ",i._listeners))})),s(this,"unregisterFromEvent",(function(e,t){if(i._listeners[e]){for(var n=i._listeners[e],r=[],o=0;o<n.length;o++){var a=n[o];a!==t&&r.push(a)}i._listeners[e]=r}})),s(this,"_onEvent",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"AE",n=t+"___"+e.name;i._notifyListeners(e,n,t)})),s(this,"_notifyListeners",(function(t,n,r){if(i._isEnabled){if(K.debug("Notifying listeners for event: "+t+", "+n,i._listeners),i._listeners[n])for(var o=i._listeners[n],a=e.getController().getSDKRunningTimeInSec(),s=0;s<o.length;s++){(0,o[s])(r,t.name,a,t.additional_info)}}else i._buffer.push({event:t,key:n,type:r})}))})),Y=window.ApxorLogger,$=function(){function t(){var i=this;return r(this,t),s(this,"_isInitialized",!1),s(this,"_configLookup",null),s(this,"_date",y()),s(this,"_eventsListener",new z),s(this,"_siteId",e.getSiteId()),s(this,"_qeState",{}),s(this,"getQeState",(function(){try{var t=e.getController().getFromStorage("qe_state");return t?JSON.parse(f(i._siteId,t)):(i._qeState={},i.setQeState())}catch(e){return i._qeState={},i.setQeState()}})),s(this,"setQeState",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";try{e.getController().persistToStorage("qe_state",i._qeState,!0)}catch(n){""===t?i._qeState={}:i._qeState[t]={SESSION:0,OVERALL:0,DATES:{}},e.getController().persistToStorage("qe_state",i._qeState,!0)}return i._qeState})),s(this,"initialize",(function(){i._isInitialized||(i._isInitialized=!0,i._configLookup=new Q,i._eventsListener.initialize(),i._qeState=i.getQeState(),Y.info("QE Initialized.."))})),s(this,"parse",(function(e){i._check()?(i._configLookup.parse(e),i._eventsListener.enable()):Y.warn("Must call init first. Unable to proceed")})),s(this,"validate",(function(e,t){i._check()&&i._configLookup.validate(e,t)})),s(this,"getVariantCode",(function(e){return i._configLookup.getVariantCode(e)})),s(this,"validateForTermination",(function(e,t){i._check()&&i._configLookup.validateForTermination(e,t)})),s(this,"validateForTerminationAttributes",(function(e,t){return i._configLookup.validateForTerminationAttributes(e,t)})),s(this,"updateCount",(function(e){try{d(i._qeState[e])||i.createObjConfig(e),i.incrementFrequencies(e),i.setQeState(e),i._configLookup.decrementCampaignCount(e)}catch(e){console.log("Could not update the count config:".concat(e))}})),s(this,"resetFrequencyCounts",(function(){i._configLookup.resetFrequencyCounts()})),s(this,"getFrequencyCount",(function(e){return i._configLookup.getFrequencyCount(e)})),s(this,"registerForEvent",(function(e,t){i._eventsListener.registerToEvent(e,t)})),s(this,"unregisterFromEvent",(function(e,t){i._eventsListener.unregisterFromEvent(e,t)})),s(this,"notifyEventListener",(function(e){i._eventsListener._onEvent(e)})),s(this,"fetch",(function(t,i,n,r){e.getController().fetchConfiguration(t,i,n,r)})),s(this,"_check",(function(){return i._isInitialized})),s(this,"getCampaignMetaFromQueryEngine",(function(e){return i._configLookup.getCampaignMeta(e)})),s(this,"getCEStartDate",(function(){return i._date})),t.instance||(t.instance=this),t.instance}return a(t,[{key:"createObjConfig",value:function(e){try{this._qeState=this.getQeState(),d(this._qeState[e])||(this._qeState[e]={SESSION:0,OVERALL:0,DATES:{}},this._date&&(this._qeState[e].DATES[this._date]=0),this.setQeState(e))}catch(e){Y.error("Can not create the frequency count object:"+e)}}},{key:"incrementFrequencies",value:function(e){this._qeState=this.getQeState();var t=this._qeState[e];t.SESSION=t.SESSION+1,t.OVERALL=t.OVERALL+1;var i=y();i===this._date&&t.DATES&&t.DATES[i]||(this._date=i,t.DATES={},t.DATES[this._date]=0),t.DATES[this._date]=t.DATES[this._date]+1}}],[{key:"getInstance",value:function(){return t.instance||(t.instance=new t),t.instance}}]),t}();s($,"instance",void 0),window.ceVersion=151;try{void 0===exports&&null===exports||(exports.default=$,module.exports=exports.default)}catch(e){}return $}));
